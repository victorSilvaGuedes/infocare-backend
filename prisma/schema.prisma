// Salve este arquivo como: prisma/schema.prisma
// (Versão ATUALIZADA - Sem idFamiliar na Internacao)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- Enums ---

enum StatusAssociacao {
  pendente
  aprovada
  rejeitada
}

enum StatusInternacao {
  ATIVA
  ALTA
}

enum Especialidade {
  MEDICO
  ENFERMEIRO
  TECNICO_ENFERMAGEM
  FISIOTERAPEUTA
  NUTRICIONISTA
  PSICOLOGO
  OUTRO
}

// --- Modelos ---

model Paciente {
  id             Int      @id @default(autoincrement()) @map("id_paciente")
  nome           String   @db.VarChar(255)
  cpf            String   @unique @db.VarChar(14)
  telefone       String?  @db.VarChar(20)
  dataNascimento DateTime @map("data_nascimento") @db.Date
  tipoSanguineo  String?  @map("tipo_sanguineo") @db.VarChar(5)

  internacoes Internacao[]

  @@map("Pacientes")
}

model Familiar {
  id       Int     @id @default(autoincrement()) @map("id_familiar")
  nome     String  @db.VarChar(255)
  cpf      String  @unique @db.VarChar(14)
  telefone String? @db.VarChar(20)
  email    String  @unique @db.VarChar(255)
  senha    String  @db.VarChar(255)

  // Relações:
  // A relação 'internacoesResponsaveis' foi REMOVIDA
  associacoesSolicitadas Associacao[]

  @@map("Familiares")
}

model ProfissionalSaude {
  id            Int           @id @default(autoincrement()) @map("id_profissional")
  nome          String        @db.VarChar(255)
  cpf           String        @unique @db.VarChar(14)
  telefone      String?       @db.VarChar(20)
  email         String        @unique @db.VarChar(255)
  senha         String        @db.VarChar(255)
  crm           String?       @unique @db.VarChar(20)
  coren         String?       @unique @db.VarChar(20)
  especialidade Especialidade @default(OUTRO) // enum com cargo/especialidade

  internacoesResponsaveis Internacao[] @relation("ProfissionalResponsavel")
  evolucoes               Evolucao[]

  @@map("ProfissionaisSaude")
}

model Internacao {
  id         Int @id @default(autoincrement()) @map("id_internacao")
  idPaciente Int @map("id_paciente")

  // O campo 'idFamiliar' foi REMOVIDO
  // idFamiliar  Int?      @map("id_familiar") 

  idProfissionalResponsavel Int? @map("id_profissional_responsavel")

  dataInicio  DateTime         @default(now()) @map("data_inicio") @db.Timestamp()
  dataAlta    DateTime?        @map("data_alta") @db.Timestamp()
  diagnostico String?          @db.Text
  observacoes String?          @db.Text
  status      StatusInternacao @default(ATIVA)

  quarto String? @db.VarChar(50)
  leito  String? @db.VarChar(50)

  // Relações
  paciente Paciente @relation(fields: [idPaciente], references: [id], onDelete: Cascade)

  // A relação 'familiar' foi REMOVIDA
  // familiar Familiar? @relation(fields: [idFamiliar], references: [id], onDelete: SetNull)

  profissionalResponsavel ProfissionalSaude? @relation("ProfissionalResponsavel", fields: [idProfissionalResponsavel], references: [id], onDelete: SetNull)

  evolucoes   Evolucao[]
  associacoes Associacao[]

  @@map("Internacoes")
}

model Evolucao {
  id             Int      @id @default(autoincrement()) @map("id_evolucao")
  idInternacao   Int      @map("id_internacao")
  idProfissional Int?     @map("id_profissional")
  dataHora       DateTime @default(now()) @map("data_hora") @db.Timestamp()
  descricao      String   @db.Text

  internacao   Internacao         @relation(fields: [idInternacao], references: [id], onDelete: Cascade)
  profissional ProfissionalSaude? @relation(fields: [idProfissional], references: [id], onDelete: SetNull)

  @@map("Evolucoes")
}

model Associacao {
  id              Int              @id @default(autoincrement()) @map("id_associacao")
  idFamiliar      Int              @map("id_familiar")
  idInternacao    Int              @map("id_internacao")
  dataSolicitacao DateTime         @default(now()) @map("data_solicitacao") @db.Timestamp()
  status          StatusAssociacao @default(pendente)

  familiar   Familiar   @relation(fields: [idFamiliar], references: [id], onDelete: Cascade)
  internacao Internacao @relation(fields: [idInternacao], references: [id], onDelete: Cascade)

  @@map("Associacoes")
}
